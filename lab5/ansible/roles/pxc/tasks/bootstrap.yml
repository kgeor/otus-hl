---

# - name: "Create dir symlink"
#   ansible.builtin.file:
#     src: "/usr/share/percona-server"
#     dest: "/usr/share/mysql"
#     state: "link"
- name: Stop MySQL service on all nodes
  ansible.builtin.systemd:
    name: mysql.service
    state: stopped

- name: Copy SSL certs to all nodes (./ssl dir from project)
  ansible.builtin.copy:
    src: files/ssl/ #"{{ playbook_dir }}/../../ssl/"
    dest: /var/lib/mysql/
    owner: mysql
    group: mysql
    mode: u=rw,g=rw,o=

- name: Update /etc/my.cnf
  template:
    src: etc_my.cnf.j2
    dest: /etc/my.cnf
    owner: root
    mode: 0644
  register: "config_file"
  # notify:
  #   - "Restart percona"

- name: Start bootstrap service on 1st node
  ansible.builtin.systemd:
    name: mysql@bootstrap.service
    state: started
  when: inventory_hostname == groups['db'][0]

- name: Start MySQL service on secondary nodes
  ansible.builtin.service:
    name: "mysql"
    state: "started"
    enabled: "yes"
  register: mysql_service
  when: inventory_hostname != groups['db'][0]

- name: Pause for 5 seconds to let nodes sync
  ansible.builtin.pause:
    seconds: 5

- name: Stop bootstrap service on 1st node
  ansible.builtin.systemd:
    name: mysql@bootstrap.service
    state: stopped
  when: inventory_hostname == groups['db'][0]

- name: Start MySQL service on node 1
  ansible.builtin.systemd:
    name: mysql.service
    state: started
  when: inventory_hostname == groups['db'][0]

- name: Touch marker
  ansible.builtin.copy:
    content: ""
    dest: ~/pxc-deployment/bootstrapped